<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Borsa Takip Sistemi</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #ffffff;
      color: #333;
    }
    h1 {
      text-align: center;
    }
    .buttons {
      text-align: center;
      margin-bottom: 10px;
    }
    .portfolio-table {
      width: 80%;
      max-width: 900px;
      border-collapse: collapse;
      margin: 25px auto;
      background-color: #ffffff;
    }
    .portfolio-table th,
    .portfolio-table td {
      padding: 16px;
      text-align: left;
      border-bottom: 1px solid #d5e5eb;
      position: relative;
    }
    .portfolio-table th {
      background-color: #f9f9f9;
    }
    .logo-cell img {
      width: 30px;
      height: 30px;
      border-radius: 50%;
    }
    .change-positive {
      color: #00B38A;
    }
    .change-negative {
      color: #EA324C;
    }
    .delete-button {
      cursor: pointer;
      font-size: 40px;
      color: #f44336;
      position: absolute;
      left: -30px;
      top: 50%;
      transform: translateY(-50%);
      display: none;
    }
    .delete-button:hover {
      color: #d32f2f;
    }
    .drag-handle {
      cursor: grab;
      text-align: center;
      font-size: 20px;
      color: #aaa;
      position: absolute;
      right: -30px;
      top: 50%;
      transform: translateY(-50%);
      display: none;
    }
    .drag-handle:hover {
      color: #000000;
    }
    .row-container {
      position: relative;
    }
    .dragging {
      background-color: #f0f0f0;
      opacity: 0.1;
    }
    @media (max-width: 768px) {
      .portfolio-table th,
      .portfolio-table td {
        font-size: 14px;
        padding: 8px;
      }
      .delete-button {
        left: -30px;
      }
    }
  </style>
</head>
<body>
  <h1>Borsa Takip Sistemi</h1>

  <div class="buttons">
    <button id="editModeButton" onclick="toggleEditMode()">Düzenle</button>
  </div>

  <div>
    <input type="text" id="manualStockInput" placeholder="Hisse Kodu (Ör: THYAO)" />
    <button onclick="addManualStock()">Ekle</button>
  </div>

  <table class="portfolio-table">
    <thead>
      <tr>
        <th>Logo</th>
        <th>Kod</th>
        <th>Şirket İsmi</th>
        <th>Fiyat</th>
        <th>Değişim</th>
      </tr>
    </thead>
    <tbody id="portfolioBody">
      <!-- Hisseler buraya eklenecek -->
    </tbody>
  </table>

  <script>
    const STORAGE_KEY = "addedStocks";
    let editMode = false;
    let draggedRow = null;

    function toggleEditMode() {
      editMode = !editMode;
      document.querySelectorAll(".delete-button").forEach(btn => {
        btn.style.display = editMode ? "inline-block" : "none";
      });
      document.querySelectorAll(".drag-handle").forEach(handle => {
        handle.style.display = editMode ? "inline-block" : "none";
      });
      // Edit modunda tüm satırlara draggable özelliği veriyoruz
      document.querySelectorAll("#portfolioBody tr").forEach(row => {
        row.draggable = editMode;
      });
      document.getElementById("editModeButton").textContent = editMode ? "Düzenlemeyi Kapat" : "Düzenle";
    }

    function loadStocks() {
      const storedStocks = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
      const tableBody = document.getElementById("portfolioBody");
      tableBody.innerHTML = "";
      storedStocks.forEach(stock => {
        addStockToTable(stock);
      });
    }

    function addStockToTable(stock) {
      const tableBody = document.getElementById("portfolioBody");
      const row = document.createElement("tr");
      row.className = "row-container";
      row.draggable = editMode;

      // Drag olaylarını ekliyoruz (artık satırın herhangi bir yerinden sürüklenebilir)
      row.addEventListener("dragstart", dragStartHandler);
      row.addEventListener("dragover", dragOverHandler);
      row.addEventListener("dragend", dragEndHandler);

      // Logo hücresi
      const logoCell = document.createElement("td");
      logoCell.className = "logo-cell";
      const logoImg = document.createElement("img");
      logoImg.src = stock.icon || "https://via.placeholder.com/30";
      logoImg.alt = stock.code;
      logoCell.appendChild(logoImg);
      row.appendChild(logoCell);

      // Kod hücresi
      const codeCell = document.createElement("td");
      codeCell.textContent = stock.code;
      row.appendChild(codeCell);

      // Şirket İsmi hücresi
      const nameCell = document.createElement("td");
      nameCell.textContent = stock.text || "-";
      row.appendChild(nameCell);

      // Fiyat hücresi
      const priceCell = document.createElement("td");
      priceCell.textContent = `${stock.lastprice} ₺`;
      row.appendChild(priceCell);

      // Değişim hücresi
      const changeCell = document.createElement("td");
      changeCell.textContent = `${stock.rate}%`;
      changeCell.className = stock.rate >= 0 ? "change-positive" : "change-negative";
      row.appendChild(changeCell);

      // Silme Butonu (yalnızca edit modunda görünür)
      const deleteButton = document.createElement("span");
      deleteButton.textContent = "×";
      deleteButton.className = "delete-button";
      deleteButton.style.display = editMode ? "inline-block" : "none";
      // Delete butonuna tıklanınca tıklamanın sürüklemeye karışmaması için event propagation'ı engelliyoruz
      deleteButton.addEventListener("click", function(e) {
        e.stopPropagation();
        removeStock(stock.code);
      });
      row.appendChild(deleteButton);

      // Drag Handle (görsel amaçlı; artık tüm satırdan da sürüklenebilir)
      const dragHandle = document.createElement("span");
      dragHandle.textContent = "⠿";
      dragHandle.className = "drag-handle";
      dragHandle.style.display = editMode ? "inline-block" : "none";
      row.appendChild(dragHandle);

      tableBody.appendChild(row);
    }

    function removeStock(stockCode) {
      let storedStocks = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
      storedStocks = storedStocks.filter(stock => stock.code !== stockCode);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(storedStocks));
      loadStocks();
    }

    // Drag Event Handler'ları (satırın herhangi bir yerinden başlatılabilir)
    function dragStartHandler(e) {
      draggedRow = this;
      this.classList.add("dragging");
      e.dataTransfer.effectAllowed = "move";
      // Firefox uyumluluğu için boş veri gönderiyoruz
      e.dataTransfer.setData("text/plain", "");
    }

    function dragOverHandler(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = "move";
      const targetRow = e.target.closest("tr");
      if (!targetRow || targetRow === draggedRow) return;
      const tableBody = document.getElementById("portfolioBody");
      const rowsArray = Array.from(tableBody.querySelectorAll("tr"));
      const draggedIndex = rowsArray.indexOf(draggedRow);
      const targetIndex = rowsArray.indexOf(targetRow);
      if (draggedIndex > targetIndex) {
        tableBody.insertBefore(draggedRow, targetRow);
      } else {
        tableBody.insertBefore(draggedRow, targetRow.nextSibling);
      }
    }

    function dragEndHandler(e) {
      this.classList.remove("dragging");
      draggedRow = null;
      saveNewOrder();
    }

    // Yeni sıralamayı localStorage'e kaydeder
    function saveNewOrder() {
      const tableBody = document.getElementById("portfolioBody");
      const newOrderCodes = Array.from(tableBody.children).map(row => row.children[1].textContent);
      let storedStocks = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
      storedStocks.sort((a, b) => newOrderCodes.indexOf(a.code) - newOrderCodes.indexOf(b.code));
      localStorage.setItem(STORAGE_KEY, JSON.stringify(storedStocks));
    }

    async function addManualStock() {
      const stockCode = document.getElementById("manualStockInput").value.toUpperCase();
      if (!stockCode) {
        alert("Lütfen bir hisse kodu girin.");
        return;
      }
      const storedStocks = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
      const alreadyExists = storedStocks.some(stock => stock.code === stockCode);
      if (alreadyExists) {
        alert("Bu hisse zaten eklenmiş.");
        return;
      }
      const response = await fetch(`/hisseler`);
      const stocks = await response.json();
      const stock = stocks.find(s => s.code === stockCode);
      if (!stock) {
        alert("Hisse bulunamadı.");
        return;
      }
      storedStocks.push(stock);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(storedStocks));
      addStockToTable(stock);
    }

    loadStocks();
  </script>
</body>
</html>
